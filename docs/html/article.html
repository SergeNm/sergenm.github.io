<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>N. Mugisha Serge</title>
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" />
  <!-- styles -->
  <link rel="stylesheet" href="../css/main.css" />
</head>

<body>
  <div id="admin-menu">
    <button class="btn-admin"><i class="fa fa-plus"></i> Create New Article</button>
    <button class="btn-admin"><i class="fa fa-user"></i> Profile</button>
    <button class="btn-admin"><i class="fa fa-cog"></i> Setting</button>
    <!-- <button class="btn-admin"><i class="fa fa-trash"></i> Delete</button> -->
    <button class="btn-admin" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>

  <!-- New Article -->

  <div class="title">
    <h2>Create<span> New Contact</span> </h2>
  </div>
  <div class="page-content">
    <form action="https://sergenm-brand.herokuapp.com/articles" id="form-new-article" class="decor">

      <div class="form-left-decoration"></div>
      <div class="form-right-decoration"></div>
      <div class="circle"></div>
      <div class="form-inner">
        <div class="message-info">
          <span id="message-display">Article</span>
        </div>
        <label for="title"></label>
        <input name="title" id="title" type="text" placeholder="TITLE">
        <label for="body"></label>
        <textarea name="body" id="body" placeholder="CONTENT" rows="5"></textarea>
        <label for="image_">Add Image:</label>
        <input type="file" id="image_" name="image_" accept="image/png, image/jpeg" multiple>
        <button class="btn-submit" type="submit" href="/">Submit</button>
      </div>
    </form>
  </div>

  <!-- footer -->
  <footer class="section">
    <p>
      copyright &copy;  N. Migisha Serge
      <span id="date"></span>. all rights reserved
    </p>
  </footer>
  <a class="scroll-link top-link" href="#home">
    <i class="fas fa-arrow-up"></i>
  </a>
  <!-- javascript -->
  <script src="../js/main.js"></script>

  <script>
    // const url = "https://sergenm-brand.herokuapp.com/articles";
    // let data = {
    //   title: 'TITLE FROM DOM',
    //   body: "More content should be written here",
    //   Image: [
    //     { "positioned": 1, "path": "uploads/images/dom.jpg" }
    //   ]
    // }

    // let request = new Request(url, {
    //   method: 'POST',
    //   body: JSON.stringify(data),
    //   headers: new Headers({
    //     'Content-Type': 'application/json; charset=UTF-8',
    //     'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluQGdtYWlsLmNvbSIsImlhdCI6MTY0NDMzNDc2Mn0.3tutNY_Qefk-6btiGQazuFVaQxn8tdeDFo4imdkJcAw'
    //   })
    // });

    // fetch(request)
    //   .then(function (res) {
    //     // Handle response you get from the API
    //     res.json().then(data => console.log(data))
    //   });

    const newArticleForm = document.getElementById("form-new-article");

    /**
     * We'll define the `handleFormSubmit()` event handler function in the next step.
     */
    newArticleForm.addEventListener("submit", handleFormSubmit);

    // file upload
    const imageElement = document.getElementById("image_");
    imageElement.addEventListener("change", handleFiles, false);
    function handleFiles() {
      const fileList = this.files; /* now you can work with the file list */
    }


    const displayMessage = document.getElementById("message-display")

    const checkUser = window.localStorage.getItem('user');


    if (!checkUser)
      window.location.href = "login.html";

    //LOGOUT 
    const logoutButton = document.getElementById('logout-btn');
    logoutButton.addEventListener('click', (e) => {
      window.localStorage.removeItem('user');
      window.location.href = "login.html";
    })

    /**
    * Event handler for a form submit event.
    *
    * @see https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit_event
    * 
    * @param {SubmitEvent} event
    */
    async function handleFormSubmit(event) {
      /**
       * This prevents the default behaviour of the browser submitting
       * the form so that we can handle things instead.
       */
      event.preventDefault();

      /**
       * This gets the element which the event handler was attached to.
       *
       * @see https://developer.mozilla.org/en-US/docs/Web/API/Event/currentTarget
       */
      const form = event.currentTarget;

      /**
       * This takes the API URL from the form's `action` attribute.
       */
      const url = form.action;

      try {
        const formData = new FormData(form);
        const responseData = await postFormDataAsJson({ url, formData });

        //use message from local storage
        

        // const Article = {
        //   message: responseData.message
        // }
        // window.localStorage.setItem('article', JSON.stringify(Article));

        // const checkArticle = window.localStorage.getItem('article');

        // const articleData = JSON.parse(window.localStorage.getItem('article'));


        // displayMessage.innerText = articleData.message

        // window.location.href = "article.html";
        // console.log({ responseData });
        

        console.log({ responseData });

      } catch (error) {
        console.error(error);
        displayMessage.innerText = JSON.parse(error.message).message
      }
    }

    /**
     * Helper function for POSTing data as JSON with fetch.
     *
     * @param {Object} options
     * @param {string} options.url - URL to POST data to
     * @param {FormData} options.formData - `FormData` instance
     * @return {Object} - Response body from URL that was POSTed to
     */
    async function postFormDataAsJson({ url, formData }) {
      /**
       * We can't pass the `FormData` instance directly to `fetch`
       * as that will cause it to automatically format the request
       * body as "multipart" and set the `Content-Type` request header
       * to `multipart/form-data`. We want to send the request body
       * as JSON, so we're converting it to a plain object and then
       * into a JSON string.
       * 
       * @see https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST
       * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/fromEntries
       * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify
       */
      const plainFormData = Object.fromEntries(formData.entries());
      const formDataJsonString = JSON.stringify(plainFormData);

      console.log(formDataJsonString);

      const userData = JSON.parse(window.localStorage.getItem('user'));
      const token = userData.token;

      const fetchOptions = {
        /**
         * The default method for a request with fetch is GET,
         * so we must tell it to use the POST HTTP method.
         */
        method: "POST",
        /**
         * These headers will be added to the request and tell
         * the API that the request body is JSON and that we can
         * accept JSON responses.
         */
        headers: {
          'Content-Type': 'application/json; charset=UTF-8',
          'Authorization': `Bearer ${token}`,
          "Accept": "application/json"
        },
        /**
         * The body of our POST request is the JSON string that
         * we created above.
         */
        body: formDataJsonString,
      };

      const response = await fetch(url, fetchOptions);

      if (!response.ok) {
        const errorMessage = await response.text();
        displayMessage.innerHTML = "error" + errorMessage;
        throw new Error(errorMessage);
      }

      displayMessage.innerHTML = "Article created successfuly"

      return response.json();
    }

  </script>

</body>
</html>