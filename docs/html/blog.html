<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>N. Mugisha Serge</title>
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" />
  <!-- styles -->
  <link rel="stylesheet" href="../css/main.css" />
</head>

<body>
  <div id="admin-menu">
    <button class="btn-admin"><i class="fa fa-sign-in-alt"></i> Sign In </button>
    <button class="btn-admin"><i class="fa fa-home"></i> <a href="../index.html" style="color: #fff;">home</a> </button>
    <!-- <button class="btn-admin"><i class="fa fa-cog"></i> Setting</button>
    <button class="btn-admin"><i class="fa fa-trash"></i> Delete</button>
    <button class="btn-admin" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button> -->
  </div>

  <!-- BLOG POST -->
  <div class="blog-viewer">

  </div>

  <div class="comment-viewer">
    <h3> Comments </h3>
    <div id="add-comment">
      <form action="https://sergenm-brand.herokuapp.com/comments" id="form-new-comment">
        <textarea placeholder="Your Comment..." rows="5" id="comment-value"></textarea>
        <button class="btn-submit" type="submit">Send</button>
      </form>

    </div>

    <div id="a-comment">
    </div>
  </div>



  <!-- footer -->
  <footer class="section">
    <p>
      copyright &copy; N. Migisha Serge
      <span id="date"></span>. all rights reserved
    </p>
  </footer>
  <a class="scroll-link top-link" href="#home">
    <i class="fas fa-arrow-up"></i>
  </a>
  <!-- javascript -->
  <script src="../js/main.js"></script>
  <script>
    var _id = parent.document.URL.substring(parent.document.URL.indexOf('?'), parent.document.URL.length);
    _id = _id.slice(1,)

    const url = `https://sergenm-brand.herokuapp.com/articles/${_id}`;

    ////////////////////
    //FETCH ARTICLE  //
    ///////////////////
    const articleContent = document.querySelector('.blog-viewer');
    fetch(url)
      .then((response) => {
        return response.json();
      })
      .then((article) => {

        // var img_ = document.createElement('img');
        // img_.src = img;
        // showImg.appendChild(img_);

        const addArticle =
          `<h1>${article.title}</h1>
              <div>
                <img src=${article.image} alt="image">
              </div>
              <div>
                <p>${article.body}</p>
              </div>`

        articleContent.insertAdjacentHTML('afterbegin', addArticle);

      })



    ////////////////////
    //FETCH COMMENTS  //
    ///////////////////
    const url2 = `https://sergenm-brand.herokuapp.com/comments/article/${_id}`
    const aComment = document.querySelector('#a-comment');
    fetch(url2)
      .then((response) => {
        return response.json();
      })
      .then((comment) => {

        // var img_ = document.createElement('img');
        // img_.src = img;
        // showImg.appendChild(img_);
        comment.map(function (comment) {
          console.log(comment)
          const addArticle =
            ` <div class="all-comments">
            <p> ${comment.user.username} <p/>  :  
             <h4>  ${comment.comment} </h4>`

          aComment.insertAdjacentHTML('afterbegin', addArticle);
        })

      })

    ////////////////////
    //POST COMMENT  //
    ///////////////////

    const checkUser = window.localStorage.getItem('user');
    console.log(checkUser);

    const newComment = document.getElementById("form-new-comment");
    newArticleForm.addEventListener("submit", handleFormSubmit);


    async function handleFormSubmit(event) {

      event.preventDefault();
      const form = event.currentTarget;

      const checkUser = window.localStorage.getItem('user');
        if (!checkUser)
            window.location.href = "login.html";
      
      const userId = checkUser._id;
      console.log('==========',checkUser);

      const url3 = `https://sergenm-brand.herokuapp.com/comments/create/${_id}`;


      try {
        // const formData = new FormData(form);
        // const responseData = await postFormDataAsJson({ url, formData });


        const comment_ = document.getElementById('comment-value').value;
        const data = {
          comment: comment_,
          articleId: _id,
        }

        const responseData = await postFormDataAsJson({ url, data });
        console.log("==========", img)



        console.log({ responseData });

      } catch (error) {
        console.error(error);
        displayMessage.innerText = JSON.parse(error.message).message
      }
    }

    async function postFormDataAsJson({ url, data }) {

      // const plainFormData = Object.fromEntries(formData.entries());



      // console.log(plainFormData)
      const formDataJsonString = JSON.stringify(data);





      const userData = JSON.parse(window.localStorage.getItem('user'));
      const token = userData.token;

      const fetchOptions = {

        method: "POST",

        headers: {
          'Content-Type': 'application/json; charset=UTF-8',
          'Authorization': `Bearer ${token}`,
          "Accept": "application/json"
        },
        /**
         * The body of our POST request is the JSON string that
         * we created above.
         */
        body: formDataJsonString,
      };

      const response = await fetch(url, fetchOptions);

      if (!response.ok) {
        const errorMessage = await response.text();
        displayMessage.innerHTML = "error" + errorMessage;
        throw new Error(errorMessage);
      }

      displayMessage.innerHTML = "Article created successfuly"

      return response.json();
    }

  </script>

</body>

</html>